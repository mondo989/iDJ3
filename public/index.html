<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iDJ Music Player</title>
    <link rel="stylesheet" href="styles.css">

    <script src="https://www.youtube.com/iframe_api"></script>
    <script type="module">
        import { djIntros, enjoyTexts } from './config.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getDatabase, ref, query, orderByKey, startAfter, limitToFirst, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

        let app, database, currentSongKey;
        let player;

        fetch('/firebase-config')
            .then(response => response.json())
            .then(config => {
                app = initializeApp(config);
                database = getDatabase(app);
                loadInitialSong();
            })
            .catch(error => console.error('Error loading Firebase config:', error));

        function loadInitialSong() {
            const lastSongQuery = query(ref(database, 'songs'), orderByKey(), limitToFirst(1));
            onValue(lastSongQuery, snapshot => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const [firstKey] = Object.keys(data);
                    currentSongKey = firstKey;
                    const firstSong = data[firstKey];
                    updateCurrentSongDisplay(firstSong);

                    const djIntro = djIntros[Math.floor(Math.random() * djIntros.length)];
                    const introText = `${djIntro}Here is the next song for you. Enjoy!`;

                    generateTTSAndPlayVideo(introText, firstSong.url);
                } else {
                    console.log('No data available');
                }
            });
        }

        function updateCurrentSongDisplay(song) {
            document.getElementById('currentSong').textContent = `${song.title} - ${song.artist}`;
            document.getElementById('requestedBy').textContent = `Requested By ${song.requester}`;
        }

        function onYouTubeIframeAPIReady() {
            // This function will be called automatically by the YouTube API
        }

        function loadYouTubeVideo(url) {
            const videoId = extractVideoId(url);
            const playerDiv = document.getElementById('player');
            playerDiv.innerHTML = ''; // Clear the existing player div

            const newPlayerDiv = document.createElement('div');
            newPlayerDiv.id = 'yt-player';
            playerDiv.appendChild(newPlayerDiv);

            player = new YT.Player('yt-player', {
                height: '390',
                width: '640',
                videoId: videoId,
                playerVars: {
                    'autoplay': 0,  // Do not autoplay the video
                    'mute': 0       // Unmute the video
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function extractVideoId(url) {
            const urlParams = new URLSearchParams(new URL(url).search);
            return urlParams.get('v');
        }

        function onPlayerReady(event) {
            // No auto-play to ensure TTS plays first
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.ENDED) {
                skipToNextSong();
            }
        }

        document.getElementById('skipSong').addEventListener('click', skipToNextSong);

        function skipToNextSong() {
            const nextSongQuery = query(ref(database, 'songs'), orderByKey(), startAfter(currentSongKey), limitToFirst(1));
            onValue(nextSongQuery, snapshot => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const [nextKey] = Object.keys(data);
                    currentSongKey = nextKey;
                    const nextSong = data[nextKey];
                    updateCurrentSongDisplay(nextSong);

                    const djIntro = djIntros[Math.floor(Math.random() * djIntros.length)];
                    const enjoyText = enjoyTexts[Math.floor(Math.random() * enjoyTexts.length)];
                    const introText = `${djIntro} This is ${nextSong.title}, by ${nextSong.artist}. Requested by ${nextSong.requester}, ${enjoyText}`;

                    destroyIframe();
                    loadYouTubeVideo(nextSong.url); // Load the next iframe first
                    generateTTSAndPlayVideo(introText);
                } else {
                    alert('No more songs in the queue.');
                }
            });
        }

        function destroyIframe() {
            const playerDiv = document.getElementById('player');
            playerDiv.innerHTML = ''; // Clear the existing player div
        }

        function generateTTSAndPlayVideo(introText) {
            fetch('/generate-speech', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ text: introText })
            })
            .then(response => response.json())
            .then(data => {
                const timestamp = new Date().getTime(); // Generate a timestamp to bust cache
                const audio = new Audio(`${data.filePath}?t=${timestamp}`); // Append timestamp to file path
                audio.play().then(() => {
                    audio.onended = () => {
                        if (player && player.playVideo) {
                            player.playVideo();
                        }
                    };
                }).catch(error => {
                    console.error('Error playing audio:', error);
                    // Fallback to play video if audio fails
                    if (player && player.playVideo) {
                        player.playVideo();
                    }
                });
            })
            .catch(error => console.error('Error generating TTS:', error));
        }
    </script>
</head>
<body>
    <div id="musicPlayer">
        <h2 id="currentSong">[Song Title] - [Artist]</h2>
        <p id="requestedBy">Requested By [Requester Name]</p>
        <button id="skipSong">Skip Song</button>
        <div id="player"></div>
    </div>
</body>
</html>
