<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iDJ Music Player</title>
    <link rel="stylesheet" href="styles.css">
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getDatabase, ref, query, orderByKey, startAfter, limitToFirst, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

        let app, database, currentSongKey;

        fetch('/firebase-config')
            .then(response => response.json())
            .then(config => {
                app = initializeApp(config);
                database = getDatabase(app);
                loadInitialSong();
            })
            .catch(error => console.error('Error loading Firebase config:', error));

        function loadInitialSong() {
            const lastSongQuery = query(ref(database, 'songs'), orderByKey(), limitToFirst(1));
            onValue(lastSongQuery, snapshot => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const [firstKey] = Object.keys(data);
                    currentSongKey = firstKey;
                    const firstSong = data[firstKey];
                    updateCurrentSongDisplay(firstSong);
                    loadYouTubeVideo(firstSong.url);
                    console.log('Song data fetched:', firstSong);
                } else {
                    console.log('No data available');
                }
            });
        }

        function updateCurrentSongDisplay(song) {
            document.getElementById('currentSong').textContent = `${song.title} - ${song.artist}`;
            document.getElementById('requestedBy').textContent = `Requested By ${song.requester}`;
        }

        function onYouTubeIframeAPIReady() {
            // This function will be called automatically by the YouTube API
        }

        function loadYouTubeVideo(url) {
            const videoId = extractVideoId(url);
            const playerDiv = document.getElementById('player');
            playerDiv.innerHTML = ''; // Clear the existing player div

            const newPlayerDiv = document.createElement('div');
            newPlayerDiv.id = 'yt-player';
            playerDiv.appendChild(newPlayerDiv);

            new YT.Player('yt-player', {
                height: '390',
                width: '640',
                videoId: videoId,
                playerVars: {
                    'autoplay': 1,
                    'mute': 1
                },
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function extractVideoId(url) {
            const urlParams = new URLSearchParams(new URL(url).search);
            return urlParams.get('v');
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.ENDED) {
                alert('Video has ended.');
                skipToNextSong();
            }
        }

        document.getElementById('skipSong').addEventListener('click', skipToNextSong);

        function skipToNextSong() {
            const nextSongQuery = query(ref(database, 'songs'), orderByKey(), startAfter(currentSongKey), limitToFirst(1));
            onValue(nextSongQuery, snapshot => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const [nextKey] = Object.keys(data);
                    currentSongKey = nextKey;
                    const nextSong = data[nextKey];
                    updateCurrentSongDisplay(nextSong);
                    loadYouTubeVideo(nextSong.url);
                    console.log('Next song data fetched:', nextSong);
                } else {
                    alert('No more songs in the queue.');
                }
            });
        }
    </script>
</head>
<body>
    <div id="musicPlayer">
        <h2 id="currentSong">[Song Title] - [Artist]</h2>
        <p id="requestedBy">Requested By [Requester Name]</p>
        <button id="skipSong">Skip Song</button>
        <div id="player"></div>
    </div>
</body>
</html>
